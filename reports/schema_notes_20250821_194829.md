# Race Info Schema Analysis and Normalization Strategy
*Generated: 2025-08-21 19:48:29*

## Current Schema Analysis

Based on analysis of 278 complete prediction files with race_info fields:

### Distance Field
- **Type**: String (all existing files use string format)
- **Format**: "{number}m" (e.g., "350m", "400m", "530m")
- **Range**: 278m to 730m observed
- **Pattern**: Always ends with "m", numeric prefix

### Grade Field 
- **Type**: String
- **Formats observed**:
  - Single number: "5", "4", "6" (shorter format)
  - "Grade N": "Grade 5", "Grade 6" (verbose format)
  - "Grade M": Maiden races
  - "M": Maiden races (short format)
  - Complex: "Grade 4/5", "Tier 3 - Maiden", "Grade Free For All", "Grade S/E Heat"

### Common Distance Values
Most frequent distances from complete files:
- 300m (29 files)
- 450m (26 files) 
- 400m (21 files)
- 520m (20 files)
- 350m (19 files)
- 457m (15 files)

### Grade Distribution  
Most common grade patterns:
- "Grade 5" (most frequent)
- "5" (short format)
- "Grade M" / "M" (maiden races)
- "Grade 4/5" (mixed grades)

## Normalization Strategy

**Principle**: Maintain backward compatibility with existing consumers while ensuring consistency.

### Distance Normalization
- **Keep string format**: Maintain "{number}m" format as this is 100% consistent in existing data
- **Validation**: Ensure numeric part is 3-4 digits representing meters
- **Example**: "520m" stays "520m" (not converted to integer 520)

### Grade Normalization  
- **Preserve existing formats**: Do not force standardization as both "5" and "Grade 5" coexist
- **Common mappings**:
  - "Maiden" → "M" 
  - "Grade Maiden" → "M"
  - Preserve complex grades as-is: "Grade 4/5", "Tier 3 - Maiden"
  - Keep numeric grades in their original format

### Implementation Guidelines

1. **Distance extraction from filename/content**:
   - Regex: `r"(\d{3,4})m?"` to capture 3-4 digit distances
   - Always append "m" if not present
   - Common distances: 300, 350, 400, 450, 457, 500, 520, 530, 600, 730

2. **Grade extraction**:
   - Look for: "Grade N", "G N", single digits "5", "M", "Maiden"
   - Preserve original format when found
   - Map "Maiden" variants to "M" for consistency

3. **Source priority** (in order of preference):
   - Database lookups by (venue, date, race_number)
   - Filename patterns
   - Race name/event fields
   - Form guide headers (non-historical data only)

## Breaking Changes Avoided

- No integer conversion of distances (keeps "520m" not 520)
- No forced grade standardization (both "5" and "Grade 5" remain valid)
- Existing API consumers will continue to work unchanged

## Quality Assurance

- Files with distance/grade will be validated against common ranges
- Anomaly detection for unusual values (e.g., distances outside 278-730m range)
- Backup all files before modification for rollback capability
